{% extends 'base.html' %}
{% load staticfiles %}
{% block content %}

<link rel="stylesheet" href="{% static 'blog/css/user_center.css' %}">

<script type="text/javascript">

    // Press Enter in email textbox will trigger save event.
    function trySaveEmail(){
        var lKeyCode = (navigator.appname=="Netscape")?event.which:window.event.keyCode;
        if (lKeyCode == 13){
            saveEmail();
        }
    }

    function saveEmail(){
        var newEmail = $('#email').val();
        if(newEmail.indexOf('@') <= 0){
            $('#email').focus();
            $('#emailError').show();
            $('#emailMsg').text("邮箱地址不正确");
            return false;
        }
        
        $.get("/UpdateUserInfo", { 'email' : newEmail }, function(result){
                if(result != "1"){
                    $('#emailError').show();
                    $("#emailMsg").text(result);
                }else{
                    $('#EmailDisplay b').text(newEmail);
                    $('#EmailInput').hide();
                    $('#EmailDisplay').show();
                }
            });
    }

    function updateEmail(){
        $('#email').val($('#EmailDisplay b').text())
        $('#EmailInput').show();
        $('#EmailDisplay').hide();
    }
</script>

<div class="personalinfo">
	<div class="briefleftbox">
    	<div class="briefpic"><span><img src="{% static 'blog/img/default_user_big.jpg' %}"></span></div>
        <div class="briefwit">
        	<h4>
			{{ request.user.username }}			<span class="{{ request.userprofile.website_level }}"></span>
			</h4>
            <div>
                <a class="btn btn-success" href="{% url 'blog:NewArticle' %}">发布新文章</a>
            </div>
        </div>
    </div>
    <em></em>
    <div class="integralbox integralboxtop">
    	<ul> 
        	<li>我的邮箱：
                <div id="EmailInput" {% if base_info.email = "" %} 
                style="display: block;"
                {% else %}
                style="display: none;"
                {% endif %}
                >
                    <input id="email" type="email" placeholder="sample@test.com" onkeydown="trySaveEmail()" value="">
                    <a href="#" class="btn btn-danger btn-small" onclick="saveEmail()">保存</a>
                    <div class="tipsboxalert" id="emailError" style="display: none;">
                        <p id="emailMsg"></p>
                    </div>
                    <div class="clear"></div>
                </div>
                <div id="EmailDisplay" {% if base_info.email = "" %} 
                style="display: none;"
                {% else %}
                style="display: block;"
                {% endif %}>
                    <b>{{ base_info.email }}</b>
                    <a href="#" class="btn btn-danger btn-small" onclick="updateEmail()">修改</a>
                </div>
            </li>
            <li>最近登录：<b>{{ base_info.last_login }}</b></li>
            <li>我的消费：<b>{{ base_info }}</b></li>
            <li>我的头衔：<i>蜻蜓点水</i></li>
        </ul>
    </div>
    <em></em>
    <div class="integralbox integralboxtop">
    	<ul>
        	<li>我的上传：{{ uploaded_files | length }} 篇</li>
            <li>我的下载：{{ downloaded_files | length }} 篇</li>
            <li>我的收藏：<a href="#">{{ liked_articles | length }}</a> 篇</li>
        </ul>
    </div>
    <div class="clear"></div>
</div>

<div class="personal">
    <div class="personalleft" id="personalleft">
        <div class="listbox nav nav-tabs">
            <a href="#basic" data-toggle="basic">基本信息</a>
            <a href="#upload" data-toggle="tab">我的上传：{{ uploaded_files | length }} 篇</a>
            <a href="#purchase" data-toggle="tab">我的下载：{{ downloaded_files | length }} 篇</a>
            <a href="#like" data-toggle="tab">我的收藏：{{ liked_articles | length }} 篇</a>
        </div>
    </div>
    <div class="personalright tab-content" id="personalright">
        <div class="tab-pane fade in active" id="basic">
            <table id="basicArticles"></table>
        </div>
        <div class="tab-pane fade" id="upload">
            <table id="myUploadedArticles"></table>
        </div>
        <div class="tab-pane fade" id="purchase">
            <table id="myPurchasedArticles"></table>
        </div>
        <div class="tab-pane fade" id="like">
            <table id="myLikedArticles"></table>
        </div>
    </div>
    <div class="clear"></div>
</div>

<script type="text/javascript">
var columns = [{
                checkbox: true
            }, {
                field: 'title',
                title: '标题'
            }, {
                field: 'created_time',
                title: '创建时间'
            }, {
                field: 'status',
                title: '文章状态'
            }, {
                field: 'views',
                title: '浏览量'
            }, {
                field: 'likes',
                title: '点赞数'
            }, {
                field: 'price',
                title: '价格'
            }, {
                field: 'category',
                title: '分类'
            }, {
                field: 'tag',
                title: '标签'
            },]

function showArticles(table_id, url){
    var oTable = new TableInit(table_id, url, columns);
    oTable.Init();
}

$(function () {
    showArticles("#basicArticles","/GetArticles/all",columns);
    showArticles("#myUploadedArticles","/GetArticles/upload",columns);
    showArticles("#myPurchasedArticles","/GetArticles/purchase",columns);
    showArticles("#myLikedArticles","/GetArticles/like",columns);
});

var TableInit = function (table_id, url, columns) {
    var oTableInit = new Object();
    //初始化Table
    oTableInit.Init = function () {
        $(table_id).bootstrapTable({
            url: url,         //请求后台的URL（*）
            method: 'get',                      //请求方式（*）
            //toolbar: '#toolbar',                //工具按钮用哪个容器
            striped: true,                      //是否显示行间隔色
            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true,                   //是否显示分页（*）
            sortable: false,                     //是否启用排序
            sortOrder: "asc",                   //排序方式
            queryParams: oTableInit.queryParams,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
            search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
            strictSearch: true,
            showColumns: true,                  //是否显示所有的列
            showRefresh: true,                  //是否显示刷新按钮
            minimumCountColumns: 2,             //最少允许的列数
            clickToSelect: true,                //是否启用点击选中行
            height: 500,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
            uniqueId: "id",                     //每一行的唯一标识，一般为主键列
            showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
            cardView: false,                    //是否显示详细视图
            detailView: false,                   //是否显示父子表
            columns: columns
        });
    };

    //得到查询的参数
    oTableInit.queryParams = function (params) {
        var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            limit: params.limit,   //页面大小
            offset: params.offset  //页码
        };
        return temp;
    };
    return oTableInit;
};

</script>

{% endblock %}

